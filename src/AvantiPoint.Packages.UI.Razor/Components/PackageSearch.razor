@using AvantiPoint.Packages.UI.Services
@using AvantiPoint.Packages.Protocol.Models
@using Microsoft.AspNetCore.Components.Web

@namespace AvantiPoint.Packages.UI.Components
@inject INuGetSearchService SearchService

<HeadContent>
    <link href="_content/AvantiPoint.Packages.UI.Razor/AvantiPoint.Packages.UI.Razor.bundle.scp.css" rel="stylesheet" />
</HeadContent>

<div class="nuget-package-search">
    <div class="row g-3">
        <!-- Sidebar Filters -->
        <div class="col-md-3 col-lg-2">
            <div class="filters-panel">
                <h6 class="mb-3">Filters</h6>

                <!-- Package Type Filter -->
                <div class="filter-group mb-3">
                    <label class="form-label fw-semibold small">Package type</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="packageType" id="typeAll"
                            checked="@(selectedPackageType == null)" @onchange="@(e => SetPackageType(null))" />
                        <label class="form-check-label small" for="typeAll">All types</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="packageType" id="typeDependency"
                            checked="@(selectedPackageType == "Dependency")"
                            @onchange='@(e => SetPackageType("Dependency"))' />
                        <label class="form-check-label small" for="typeDependency">Dependency</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="packageType" id="typeTemplate"
                            checked="@(selectedPackageType == "Template")"
                            @onchange='@(e => SetPackageType("Template"))' />
                        <label class="form-check-label small" for="typeTemplate">Template</label>
                    </div>
                </div>

                <!-- Framework Filter -->
                <div class="filter-group mb-3">
                    <label class="form-label fw-semibold small">Frameworks</label>
                    <select class="form-select form-select-sm" @onchange="OnFrameworkChanged">
                        <option value="">Any framework</option>
                        <optgroup label=".NET">
                            <option value="net10.0">net10.0</option>
                            <option value="net9.0">net9.0</option>
                            <option value="net8.0">net8.0</option>
                            <option value="net7.0">net7.0</option>
                            <option value="net6.0">net6.0</option>
                            <option value="net5.0">net5.0</option>
                        </optgroup>
                        <optgroup label=".NET Core">
                            <option value="netcoreapp3.1">netcoreapp3.1</option>
                            <option value="netcoreapp3.0">netcoreapp3.0</option>
                            <option value="netcoreapp2.2">netcoreapp2.2</option>
                            <option value="netcoreapp2.1">netcoreapp2.1</option>
                        </optgroup>
                        <optgroup label=".NET Standard">
                            <option value="netstandard2.1">netstandard2.1</option>
                            <option value="netstandard2.0">netstandard2.0</option>
                            <option value="netstandard1.6">netstandard1.6</option>
                        </optgroup>
                        <optgroup label=".NET Framework">
                            <option value="net48">net48</option>
                            <option value="net472">net472</option>
                            <option value="net462">net462</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Options -->
                <div class="filter-group">
                    <label class="form-label fw-semibold small">Options</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="prereleaseToggle" @bind="includePrerelease"
                            @bind:after="PerformSearch" />
                        <label class="form-check-label small" for="prereleaseToggle">Include prerelease</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="compatibleFrameworks"
                            @bind="includeCompatibleFrameworks" @bind:after="PerformSearch" />
                        <label class="form-check-label small" for="compatibleFrameworks">Include compatible
                            frameworks</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-md-9 col-lg-10">
            <!-- Search Box -->
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="@Placeholder" @bind="searchQuery"
                    @bind:event="oninput" @onkeydown="HandleKeyDown" />
                <button class="btn btn-primary" @onclick="PerformSearch" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span class="ms-1">Searching...</span>
                    }
                    else
                    {
                        <span>Search</span>
                    }
                </button>
            </div>

            @if (errorMessage != null)
            {
                <div class="alert alert-danger" role="alert">
                    @errorMessage
                </div>
            }

            @if (searchResults != null)
            {
                <div class="search-results">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="text-muted">
                            @if (searchResults.TotalHits == 0)
                            {
                                <text>No packages found</text>
                            }
                            else if (searchResults.TotalHits == 1)
                            {
                                <text>1 package</text>
                            }
                            else
                            {
                                <text>@searchResults.TotalHits.ToString("N0") packages</text>
                            }
                        </div>
                    </div>

                    @if (searchResults.Data?.Count > 0)
                    {
                        <div class="list-group mb-3">
                            @foreach (var package in searchResults.Data)
                            {
                                <div class="list-group-item list-group-item-action">
                                    <PackageSearchResultItem Package="package" OnPackageClick="HandlePackageClick" />
                                </div>
                            }
                        </div>

                        @if (HasMoreResults || currentPage > 0)
                        {
                            <nav class="d-flex justify-content-between align-items-center" aria-label="Pagination">
                                <button class="btn btn-sm btn-outline-secondary" @onclick="LoadPreviousPage"
                                    disabled="@(currentPage == 0 || isLoading)">
                                    ← Previous
                                </button>
                                <span class="small text-muted">Page @(currentPage + 1)</span>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="LoadNextPage"
                                    disabled="@(!HasMoreResults || isLoading)">
                                    Next →
                                </button>
                            </nav>
                        }
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
#nullable enable
    private string searchQuery = "";
    private bool includePrerelease = false;
    private bool includeCompatibleFrameworks = false;
    private string? selectedPackageType = null;
    private string? selectedFramework = null;
    private bool isLoading = false;
    private string? errorMessage = null;
    private SearchResponse? searchResults = null;
    private int currentPage = 0;
    private const int PageSize = 20;

    [Parameter]
    public string Placeholder { get; set; } = "Search packages...";

    [Parameter]
    public EventCallback<SearchResult> OnPackageSelected { get; set; }

    [Parameter]
    public int ResultsPerPage { get; set; } = 20;

    private bool HasMoreResults =>
    searchResults != null &&
    ((currentPage + 1) * ResultsPerPage) < searchResults.TotalHits;

    protected override async Task OnInitializedAsync()
    {
        await PerformSearch();
    }

    private async Task SetPackageType(string? packageType)
    {
        selectedPackageType = packageType;
        currentPage = 0;
        await PerformSearch();
    }

    private async Task OnFrameworkChanged(ChangeEventArgs e)
    {
        selectedFramework = string.IsNullOrWhiteSpace(e.Value?.ToString()) ? null : e.Value.ToString();
        currentPage = 0;
        await PerformSearch();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            currentPage = 0;
            await PerformSearch();
        }
    }

    private async Task PerformSearch()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            searchResults = await SearchService.SearchAsync(
            query: string.IsNullOrWhiteSpace(searchQuery) ? null : searchQuery,
            skip: currentPage * ResultsPerPage,
            take: ResultsPerPage,
            includePrerelease: includePrerelease,
            packageType: selectedPackageType,
            framework: selectedFramework);
        }
        catch (Exception ex)
        {
            errorMessage = $"Search failed: {ex.Message}";
            searchResults = null;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadNextPage()
    {
        currentPage++;
        await PerformSearch();
    }

    private async Task LoadPreviousPage()
    {
        if (currentPage > 0)
        {
            currentPage--;
            await PerformSearch();
        }
    }

    private async Task HandlePackageClick(SearchResult package)
    {
        if (OnPackageSelected.HasDelegate)
        {
            await OnPackageSelected.InvokeAsync(package);
        }
    }
}