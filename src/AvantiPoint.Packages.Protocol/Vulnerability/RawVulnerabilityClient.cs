using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Threading;
using System.Threading.Tasks;
using AvantiPoint.Packages.Protocol.Models;

namespace AvantiPoint.Packages.Protocol.Internal
{
    /// <summary>
    /// The client to interact with an upstream source's Vulnerability Info resource.
    /// </summary>
    public class RawVulnerabilityClient : IVulnerabilityClient
    {
        private readonly HttpClient _httpClient;
        private readonly string _vulnerabilityIndexUrl;

        /// <summary>
        /// Create a new Vulnerability Info client.
        /// </summary>
        /// <param name="httpClient">The HTTP client used to send requests.</param>
        /// <param name="vulnerabilityIndexUrl">The NuGet Server's vulnerability index URL.</param>
        public RawVulnerabilityClient(HttpClient httpClient, string vulnerabilityIndexUrl)
        {
            _httpClient = httpClient ?? throw new ArgumentNullException(nameof(httpClient));
            _vulnerabilityIndexUrl = vulnerabilityIndexUrl?.TrimEnd('/')
                ?? throw new ArgumentNullException(nameof(vulnerabilityIndexUrl));
        }

        /// <inheritdoc />
        public async Task<VulnerabilityIndexResponse> GetIndexOrNullAsync(
            CancellationToken cancellationToken = default)
        {
            return await _httpClient.GetFromJsonOrDefaultAsync<VulnerabilityIndexResponse>(
                _vulnerabilityIndexUrl,
                cancellationToken);
        }

        /// <inheritdoc />
        public async Task<VulnerabilityPageResponse> GetPageOrNullAsync(
            string pageUrl,
            CancellationToken cancellationToken = default)
        {
            return await _httpClient.GetFromJsonOrDefaultAsync<VulnerabilityPageResponse>(
                pageUrl,
                cancellationToken);
        }

        /// <inheritdoc />
        public async Task<IReadOnlyList<PackageVulnerabilityInfo>> GetVulnerabilitiesAsync(
            string packageId,
            CancellationToken cancellationToken = default)
        {
            var result = new List<PackageVulnerabilityInfo>();

            // Get the vulnerability index
            var index = await GetIndexOrNullAsync(cancellationToken);
            if (index?.Pages == null || index.Pages.Count == 0)
            {
                return result.AsReadOnly();
            }

            // Fetch all pages and collect vulnerabilities for the specified package
            var normalizedPackageId = packageId.ToLowerInvariant();

            foreach (var pageInfo in index.Pages)
            {
                // Resolve page URL - it might be relative or absolute
                var pageUrl = pageInfo.Id;
                if (!Uri.IsWellFormedUriString(pageUrl, UriKind.Absolute))
                {
                    // Construct absolute URL from index URL
                    var indexUri = new Uri(_vulnerabilityIndexUrl);
                    var baseUri = new Uri(indexUri, ".");
                    pageUrl = new Uri(baseUri, pageUrl).ToString();
                }

                var page = await GetPageOrNullAsync(pageUrl, cancellationToken);
                if (page != null && page.TryGetValue(normalizedPackageId, out var vulnerabilities))
                {
                    result.AddRange(vulnerabilities);
                }
            }

            return result.AsReadOnly();
        }
    }
}
